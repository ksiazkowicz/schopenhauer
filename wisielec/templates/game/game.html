{% extends "base.html" %}
{% load static %}

{% block content %}
    <script>
        // Note that the path doesn't matter right now; any WebSocket
        // connection gets bumped over to WebSocket consumers
        socket = new WebSocket("ws://" + window.location.host + "/game/{{ game.session_id }}");
        socket.onmessage = function(e) {
            var bread = JSON.parse(e.data);
            if (bread.redirect) {
                location.href = "/game/t/" + bread.tournament + "/";
            }

            if (bread.updates) {
                for (i=0; i<bread.updates.length; i++) {
                    var update = bread.updates[i];
                    if (document.getElementById("game-"+update.session_id)) {
                        document.getElementById("game-mistakes-"+update.session_id).innerText = update.mistakes;
                        document.getElementById("game-progress-"+update.session_id).innerText = "("+update.progress+")";
                    } else {
                        alert("NOT_IMPLEMENTED");
                    }
                }
            }

            if (bread.session_id == "{{ game.session_id }}") {
                if (bread.letter) {
                    document.getElementById("used_letters").innerHTML += bread.letter + ", ";
                }
                if (bread.used_chars) {
                    document.getElementById("used_letters").innerHTML = "Wykorzystane literki: "
                    for (var i=0; i < bread.used_chars.length; i++) {
                        document.getElementById("used_letters").innerHTML += bread.used_chars[i] + ", ";
                    }
                }
                if (bread.players)
                    update_players("players-list", bread.players);
                
                if (!bread.player_list_only) {
                    document.getElementById("score").innerText = bread.score;
                    document.getElementById("mistakes").innerText = bread.mistakes;
                    document.getElementById("progress").innerText = bread.progress;

                    var img_mistakes = bread.mistakes < 5 ? bread.mistakes+1 : 6;

                    document.getElementById("pikczer").setAttribute("src", "/static/img/wis0"+(img_mistakes)+".png");
                }
            }
        }
        socket.onopen = function() {
            //socket.send("hello world");
        }
        // Call onopen directly if socket is already open
        if (socket.readyState == WebSocket.OPEN) socket.onopen();

        function test(letter) {
            socket.send(JSON.stringify({
                session_id: "{{ game.session_id }}",
                letter: letter
            }));
        }

        function uniCharCode(event) {
            var char = event.which || event.keyCode; // event.keyCode is used for IE8 and earlier
            test(String.fromCharCode(char));
        }
        function zaznacz_rzeczy() {
            document.getElementById("wpisywacz").focus();
        }
    </script>



    <h3 id="progress">{{ game.progress }}</h3>

    <div class="pull-right">
        <img id="pikczer" src="/static/img/wis0{{ game.mistakes|add:"1" }}.png">
    </div>

    <input type="text" style="color: #000; background-color: #000; height: 0; opacity: 0;" onkeypress="uniCharCode(event)" onfocusout="zaznacz_rzeczy()" autofocus id="wpisywacz">

    <div>
        {% if game.mistakes < 5 %}
        {% for x in alphabet %}
        <a href="javascript:test('{{x}}');">{{ x }}</a>
        <!--<a href="guess?letter={{ x }}">{{ x }}</a>-->
        {% endfor %}{% else %}PRZEGRALES ZYCIE LOL{% endif %}
        <p id="used_letters">
            Wykorzystane literki: {% if game.used_characters %}{% for x in game.used_characters %}{{ x }}{% if not forloop.last %},{% endif %} {% endfor %}{% endif %}
        </p>
    </div>
    <div>
        <label>Punkty</label> <p id="score">{{ game.score }}</p>
        <label>Błędy</label> <p id="mistakes">{{ game.mistakes }}</p>
    </div>
    <div><b>Lista uczestników:</b> <div id="players-list">nie żyją</div></div>

    {% if game.player %}<br/>
    <div><b>Gra</b> {{ game.player }}</div>
    {% endif %}

    {% if game.round_set.all %}
    <div class="tournament-status-line">
        <h4>Pozostali gracze</h4>
        {% for round in game.round_set.all %}
            {% for game in round.games.all %}
                <div class="tournament-status" id="game-{{ game.session_id }}">
                    <div class="game-mistakes" id="game-mistakes-{{ game.session_id }}">({{ game.mistakes }})</div>
                    <span class="player-name">{{ game.player }}</span>
                    <div class="game-progress" id="game-progress-{{ game.session_id }}">{{ game.progress_string }}</div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
    {% endif %}
{% endblock %}